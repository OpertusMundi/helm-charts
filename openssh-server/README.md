# README - openssh server

Let's say we name our release `sshd-1`.

## 1. Prepare secrets

This chart needs the following secrets:

  * a keypair (in openssh format, as generated by `ssh-keygen`) identifying the openssh server: `ssh_host_key{,.pub}`
  * an `authorized_keys` file for the connecting users 
  
Suppose we have a keypair `id_rsa{,.pub}` to identify the connecting user.

An example kustomization file to prepare these secret resources, e.g. for a release (`sshd-1`):
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

generatorOptions:
  disableNameSuffixHash: true

namePrefix: sshd-1-

configMapGenerator:
  []

secretGenerator:
- name: host-key
  files:
  - ssh_host_key=host_key
  - ssh_host_key.pub=host_key.pub
- name: auth
  files:
  - authorized_keys=id_rsa.pub
```

## 2. Install chart

Install:
    
    pvcName=... # the PVC to be mounted under /data
    helm install sshd-1 opertusmundi/openssh-server \
      --set data.pvcName=${pvcName} \
      --set hostKey.secretName=sshd-1-host-key \
      --set auth.secretName=sshd-1-auth

For more complex setup (specific UIDs etc), prefer a local `values.yaml` file.

## 3. Connect to SSH server (port forwarding)

A simple way to connect to the SSH server is by port forwarding to it.

Prepare a known-hosts file for the target SSH server (see https://superuser.com/a/1027678):

    echo -n "sshd-1.localhost $(<host_key.pub)" >known-hosts 

Port forward:

    kubectl port-forward deploy/sshd-1-openssh-server 2222:2222

In another terminal, ssh to the server:

    ssh -v -oUserKnownHostsFile=known-hosts -oIdentitiesOnly=yes -i id_rsa -p 2222 user1@sshd-1.localhost

